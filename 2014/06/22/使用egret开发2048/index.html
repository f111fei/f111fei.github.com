<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  
  <title>使用egret开发2048 | xzper</title>
  <meta name="author" content="xzper">
  
  <meta name="description" content="xzper | f111fei | egret | html5">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

  <meta property="og:title" content="使用egret开发2048"/>
  <meta property="og:site_name" content="xzper"/>

  <link rel="alternate" href="/atom.xml" title="xzper" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <!--<script src="//libs.useso.com/js/jquery/1.8.0/jquery.min.js"></script>-->
  <script src="/js/jquery.min.js"></script>
  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?f41eaf36a0e12123fc3b4874c7608a47";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
  </script>
  
</head>


<body>
  <div class="wrapper">
    <header id="header"><div class="title">
  <h1><a href="/">xzper</a></h1>
  <p><a href="/">前行在被夕阳染红的街道</a></p>
</div>
<nav class="nav">
  <ul>
    
      <li><a href="/">主页</a></li>
    
      <li><a href="/archives">所有文章</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
    <div class="content"><article class="post">
  <header>
    
      <div class="icon"></div>
      <time datetime="2014-06-22T12:41:00.000Z"><a href="/2014/06/22/使用egret开发2048/">6月 22 2014</a></time>
    
    
  
    <h1 class="title">使用egret开发2048</h1>
  

  </header>
  
  <div class="entry">
    
      <p>2048是最近很火的一个小游戏，<a href="http://gabrielecirulli.github.io/2048/" target="_blank" rel="external">原版</a> 就是用JavaScript写的。恰巧最近Egret PublicBeta，观望和学习了一阵后，发现egret正好适合开发这类游戏。Egret使用TypeScript作为开发语言，最终编译为JavaScript，正好和原始版本PK一下。</p>
<p>游戏预览：<a href="http://xzper.com/project/2048egret/" target="_blank" rel="external">点我体验</a></p>
<a id="more"></a>
<p><strong>1.准备开始</strong></p>
<p>在开始之前，我们需要学习一下TypeScript和阅读官方的教程从Egret开发环境的部署到创建，编译，发布项目，以及Egret相关工具。在安装好开发环境后，在工作空间目录下使用命令行，创建2048egret新项目</p>
<pre><code>egret <span class="operator"><span class="keyword">create</span> <span class="number">2048</span>egret</span>
</code></pre><p><strong>2.准备素材</strong></p>
<p>每一个游戏都离不开美术资源，我们需要做的就是把美术资源打包，然后加载进来使用。这一方面egret有一套完整的工作流。</p>
<p><strong>①资源打包</strong></p>
<p>这里我们用到的资源主要有按钮，背景，文字以及数字这些图片。我们选择把这些图片都打包在一起合成一张大图就像 <a href="http://xzper.com/project/2048egret/resource/assets/source.png" target="_blank" rel="external">这样</a> 和 <a href="http://xzper.com/project/2048egret/resource/assets/number.png" target="_blank" rel="external">这样</a> 这样做可以减少URL请求数，还能减少资源的体积，把一些具有相同特征的图片放在一起便于管理。在egret里面这种类型的资源就是sheet。只有图片是不够的，还需要一个json描述文件来说明这张图每一张小图片的位置和大小。目前已经有成熟的工具来生成sheet和json。这里我用到的是 <a href="http://www.renderhjs.net/shoebox/" target="_blank" rel="external">ShoeBox</a> 配合这个 <a href="https://github.com/runinspring/egretTools" target="_blank" rel="external">插件</a> 来生成egret能识别的json。安装好插件后， 将每一张图片命名，然后将这些图片选中拖入Sprites Sheet中然后配置好生成的文件名点击save就能得到一张大图和一个json了，将图片和json放入”resource/assets/“文件夹下以备使用。此外ShoeBox还能读取swf将MovieClip导出为这种大图，按每一帧自动命名，这里的number.png就是这样导出的，下面有原始素材下载地址。</p>
<p><strong>②资源加载</strong></p>
<p>接下来我们需要生成一个资源描述文件resource.json，在游戏开始之前读取这个json来加载对应的文件。egret的资源加载机制可以参考 <a href="https://github.com/egret-labs/egret-core/wiki/Using%20Resource%20System" target="_blank" rel="external">这里</a> 现在已经有 <a href="http://bbs.egret-labs.org/thread-48-1-1.html" target="_blank" rel="external">工具</a> 能自动生成这个resource.json了。按照下图配置。<strong>注意：虽然我们的资源有图片，但是对应的json文件已经记录了图片的位置，所以在这个工具中我们不需要添加对应的图片只添加json文件就行了。</strong></p>
<center><img src="http://xzper.qiniudn.com/2014/06/ResTool.png" alt=""></center>

<p>在项目初始化时，使用RES加载资源，简单明了。</p>
<pre><code><span class="keyword">private</span> <span class="title">onAddToStage</span>(event:egret.Event){
    ........
    ........
    <span class="comment">//初始化Resource资源加载库</span>
    RES.addEventListener(RES.ResourceEvent.CONFIG_COMPLETE,<span class="keyword">this</span>.onConfigComplete,<span class="keyword">this</span>);
    RES.loadConfig(<span class="string">"resource/resource.json"</span>,<span class="string">"resource/"</span>);
}

<span class="javadoc">/**
 *配置文件加载完成,开始预加载preload资源组。
 */</span>
<span class="keyword">private</span> <span class="title">onConfigComplete</span>(event:RES.ResourceEvent):<span class="keyword">void</span>{
    RES.removeEventListener(RES.ResourceEvent.CONFIG_COMPLETE,<span class="keyword">this</span>.onConfigComplete,<span class="keyword">this</span>);
    RES.addEventListener(RES.ResourceEvent.GROUP_COMPLETE,<span class="keyword">this</span>.onResourceLoadComplete,<span class="keyword">this</span>);
    RES.addEventListener(RES.ResourceEvent.GROUP_PROGRESS,<span class="keyword">this</span>.onResourceProgress,<span class="keyword">this</span>);
    RES.loadGroup(<span class="string">"preload"</span>);
}
</code></pre><p><strong>③资源使用</strong></p>
<p>在项目中我们可以使用RES来使用资源，参照对应的API。对于没有写进配置文件的资源使用RES.getResByUrl方法来异步获取。开发人员能使用极其少量的代码来完成各类资源的加载。</p>
<p><strong>3.更改模板生成的代码</strong></p>
<p><strong>①修改细节</strong></p>
<p>默认的文档类是GameApp。我觉得还是叫Main比较亲切，修改类名称，然后修改项目目录下的egretProperties.json文件，将document_class的值改为Main</p>
<pre><code>{
    "<span class="attribute">document_class</span>" : <span class="value"><span class="string">"Main"</span></span>,
    "<span class="attribute">native</span>": <span class="value">{
        "<span class="attribute">path_ignore</span>": <span class="value">[
            <span class="string">"libs"</span>
        ]
    </span>}
</span>}
</code></pre><p>默认生成的html的背景是黑色的，这里全部改成白色。将index.html里面的背景替换成#ffffff。</p>
<p>默认尺寸是480x800的尺寸。由于我们使用的部分图片宽度大于500，以及部分PC的分辨率太小为了不出现垂直滚动条影响体验，将尺寸换成520x650。这个不影响移动设备上的尺寸，移动设备默认是自适应宽度的。</p>
<p>index.html中</p>
<pre><code>&lt;div <span class="variable">style=</span><span class="string">"display:inline-block;width:100%; height:100%;margin: 0 auto; background: #ffffff; position:relative;"</span> <span class="variable">id=</span><span class="string">"gameDiv"</span>&gt;
    &lt;canvas <span class="variable">id=</span><span class="string">"gameCanvas"</span> <span class="variable">width=</span><span class="string">"520"</span> <span class="variable">height=</span><span class="string">"650"</span> <span class="variable">style=</span><span class="string">"background-color: #ffffff"</span>&gt;&lt;/canvas&gt;
&lt;/div&gt;
</code></pre><p>egret_loader.js中</p>
<pre><code>//设置屏幕适配策略
egret.StageDelegate.getInstance().setDesignSize(<span class="number">520</span>, <span class="number">650</span>);
context.<span class="variable">stage =</span> new egret.Stage();
var <span class="variable">scaleMode =</span>  egret.MainContext.<span class="variable">deviceType =</span>= egret.MainContext.DEVICE_MOBILE ? egret.StageScaleMode.SHOW_ALL : egret.StageScaleMode.NO_SCALE;
context.stage.<span class="variable">scaleMode =</span> scaleMode;
</code></pre><p><strong>③引入第三方库pureMVC</strong></p>
<p>这次我们要使用到一个mvc开发框架-pureMVC，熟悉as3的朋友一定也对这个框架不陌生吧。不熟悉的也没关系，这个框架不是这次的主角。我们从 <a href="https://github.com/PureMVC/puremvc-typescript-standard-framework" target="_blank" rel="external">这里</a> 下载pureMVC的TypeScript版本。得到puremvc-typescript-standard-1.0.d.ts 和 puremvc-typescript-standard-1.0.js这两个文件，其实.d.ts就类似于c++里面的.h头文件，只有空方法和空属性，真正的实现是在js文件或者ts文件里面。在项目里面的src文件夹下建立一个puremvc的文件夹，将这个js文件和d.ts文件放进去。然后在项目根目录下建立一个puremvc.json的文件内容如下</p>
<pre><code>{
    "<span class="attribute">name</span>": <span class="value"><span class="string">"puremvc"</span></span>,
    "<span class="attribute">source</span>":<span class="value"><span class="string">"src/puremvc/"</span></span>,
    "<span class="attribute">file_list</span>": <span class="value">[
        <span class="string">"puremvc-typescript-standard-1.0.js"</span>,
        <span class="string">"puremvc-typescript-standard-1.0.d.ts"</span>
    ]
</span>}
</code></pre><p>这样就表示配置了一个第三方模块。之后在编译器编译时会把相应的模块对应的js文件夹编译进libs文件夹下。项目里面我们还使用了gui模块，这些模块的配置是在egretProperties.json中，部分代码如下</p>
<pre><code><span class="string">"modules"</span>: [
    {
        <span class="string">"name"</span>: <span class="string">"core"</span>
    },
    {
        <span class="string">"name"</span>: <span class="string">"gui"</span>
    },
    {
        <span class="string">"name"</span>: <span class="string">"puremvc"</span>,<span class="string">"path"</span>:<span class="string">"."</span>
    }
],
</code></pre><p><strong>④注入AssetAdapter和SkinAdapter</strong></p>
<p>我们这次的主角是egret的GUI。找到官方<a href="https://github.com/egret-labs/egret-examples" target="_blank">GUIExample</a>中的这两个ts文件复制到项目的src文件夹下面，由于这个项目没有用到默认皮肤，删除ShinAdapter里面getDefaultSkin方法的默认皮肤。最后不要忘了一点，在引擎初始化的时候注入这两个Adapter。</p>
<pre><code><span class="keyword">private</span> onAddToStage(event:egret<span class="built_in">.</span>Event){
        <span class="comment">//注入自定义的素材解析器</span>
        egret<span class="built_in">.</span>Injector<span class="built_in">.</span>mapClass(<span class="string">"egret.gui.IAssetAdapter"</span>,AssetAdapter);
        <span class="comment">//注入自定义的皮肤解析器</span>
        egret<span class="built_in">.</span>Injector<span class="built_in">.</span>mapClass(<span class="string">"egret.gui.ISkinAdapter"</span>,SkinAdapter);
        <span class="attribute">...</span><span class="attribute">...</span>
        <span class="attribute">...</span><span class="attribute">...</span>
}
</code></pre><p>这两个的Adapter的作用至关重要，AssetAdapter负责解释UIAsset的source属性 ，SkinAdapter负责解释SkinnableCompent的skinName属性。这里官方提供了两个默认已经写好了的，当然我们可以自己扩展。 没有他们，UIAsset素材包装器的source属性 和 可设置皮肤的GUI组件的skinName属性毫无作用。而这两种组件是今后使用最多的。不信可以往下看 。</p>
<p><strong>⑤修改createGameScene方法</strong></p>
<p>在生成的模板中，文档类Main在经过一系列的前期准备工作之后，终于轮到GUI组件的老大UIStage上场了。UIStage类似于Flex里面的SystemManager，内置弹出窗口层，工具提示层和鼠标样式层，所有的GUI组件都应该添加到他的下面，并且UIStage全局唯一。  这里我们实现了一个AppContainer继承自UIStage。 同时在这里pureMVC框架正式启动，开始运作。</p>
<pre><code><span class="javadoc">/**
 * 创建游戏场景
 */</span>
<span class="keyword">private</span> <span class="title">createGameScene</span>():<span class="keyword">void</span> {
    var appContainer:game.AppContainer = <span class="keyword">new</span> game.AppContainer();
    <span class="keyword">this</span>.addChild(appContainer);
    game.ApplicationFacade.getInstance().startUp(appContainer);
}
</code></pre><p><strong>4.pureMVC</strong></p>
<p><strong>①Mediator</strong></p>
<p>Mediator(中介器)是连接视图也就是egret的GUI和pureMVC的桥梁。Mediator受到消息时(handleNotification)调用GUI组件的方法和设置属性，来改变视图。或者视图发生改变时通知Mediator由其发送消息到pureMVC(sendNotification)。</p>
<p><strong>ApplicationMediator</strong> 监听键盘事件或者手势发送消息到GameCommand通知移动</p>
<p><strong>MainGameMediator</strong> 接收消息，调用MainGameUI的方法处理格子的移动，添加，删除，重置，以及接收游戏结果，显示结果面板</p>
<p><strong>MainMenuMediator</strong> 接收更新分数的消息，调用MainGameUI的方法更新分数与重置</p>
<p><strong>ResultWindowMediator</strong> 发送游戏重置的消息，以及自销毁。</p>
<p><strong>②Command</strong></p>
<p>command属于控制器。负责收发消息和处理简单的事务。在StartupCommand中使用ControllerPrepCommand，ModelPrepCommand，ViewPrepCommand三个子任务。分别注册控制器，数据和视图。</p>
<p><strong>GameCommand</strong> 处理各类事务。比如 玩家按下了方向键，收到消息调用GridProxy的移动方法改变数据，比如GridProxy移动格子分数改变了，通知GameCommand 调用GameProxy的更新分数方法改变分数，比如处理重置游戏的事务，通知各个数据模块重置数据</p>
<p><strong>③Proxy</strong></p>
<p>处理数据，提供公共方法供Command调用以改变数据。改变数据了然后sendNotification通知Mediator改变视图。</p>
<p><strong>GameProxy</strong> 处理游戏数据，比如更新分数，处理游戏结果</p>
<p><strong>GridProxy</strong> 这个游戏的核心数据，操作每一个格子的数据，通知视图格子的移动，添加，删除，重置。这里包含2048这个游戏的精髓。有兴趣的可以研究下，源码里面有详细注释，这篇文章不做重点讲解。</p>
<p><strong>5.egret的GUI</strong></p>
<p><strong>①制作菜单———-认识皮肤部件</strong></p>
<p>先来看看菜单长什么样子</p>
<p><img src="http://xzper.qiniudn.com/2014/06/菜单.jpg" alt=""></p>
<p>我们会发现这个菜单。有些是静态文本，是一直不变的，我偷懒直接用了一张图片代替了，图片可以用egret.gui.UIAsset。</p>
<p>还有当前得分和最高分已经那个向上飘的数字是动态的，可以选用egret.gui.Label这个组件。</p>
<p>一个重试按钮，既然已经说了是按钮了我们就用egret.gui.Button好了。</p>
<p>接下来我们要做到皮肤和组件分离。那几个需要参与逻辑的组件自然就成了皮肤部件了。来看看MainMenuUISkin：</p>
<pre><code><span class="javadoc">/**
 * 和主机组件匹配的皮肤部件
 */</span>
<span class="keyword">private</span> <span class="keyword">static</span> _skinParts:Array&amp;lt;string&amp;gt; = [<span class="string">"addLabel"</span>,<span class="string">"scoreLabel"</span>,<span class="string">"highScoreLabel"</span>,<span class="string">"resetButton"</span>];

<span class="keyword">public</span> get <span class="title">skinParts</span>():Array&amp;lt;string&amp;gt;{
    <span class="keyword">return</span> MainMenuUISkin._skinParts;
}

<span class="javadoc">/**
 * 加分文本
 */</span>
<span class="keyword">public</span> addLabel:egret.gui.Label;

<span class="javadoc">/**
 * 总分文本
 */</span>
<span class="keyword">public</span> scoreLabel:egret.gui.Label;

<span class="javadoc">/**
 * 最高分文本
 */</span>
<span class="keyword">public</span> highScoreLabel:egret.gui.Label;

<span class="javadoc">/**
 * 重置按钮
 */</span>
<span class="keyword">public</span> resetButton:egret.gui.Button;

<span class="keyword">public</span> <span class="title">createChildren</span>():<span class="keyword">void</span>
{
    <span class="keyword">super</span>.createChildren;
    var uiAsset:egret.gui.UIAsset = <span class="keyword">new</span> egret.gui.UIAsset();
    uiAsset.source = <span class="string">"source.menu"</span>;
    <span class="keyword">this</span>.addElement(uiAsset);

    <span class="keyword">this</span>.resetButton = <span class="keyword">new</span> egret.gui.Button();
    <span class="keyword">this</span>.resetButton.skinName = ResetButtonSkin;
    <span class="keyword">this</span>.resetButton.right = <span class="number">10</span>;
    <span class="keyword">this</span>.resetButton.top = <span class="number">80</span>;
    <span class="keyword">this</span>.resetButton.label = <span class="string">"重置游戏"</span>;
    <span class="keyword">this</span>.addElement(<span class="keyword">this</span>.resetButton);

    <span class="keyword">this</span>.highScoreLabel = <span class="keyword">new</span> egret.gui.Label();
    ...省略若干代码
    <span class="keyword">this</span>.scoreLabel = <span class="keyword">new</span> egret.gui.Label();
    ...省略若干代码
    <span class="keyword">this</span>.addLabel = <span class="keyword">new</span> egret.gui.Label();
    ...省略若干代码
}
</code></pre><p>篇幅有限，省略了createChildren方法里面的子组件布局。<strong>skin的createChildren方法是在皮肤和主机组件匹配的时候被调用的。皮肤和主机组件匹配是在主机组件被添加到显示列表的时候完成的。所以只要主机组件hostComponent还没有添加到显示舞台，获取hostComponent的皮肤部件都是无效的。</strong>这也是为什么我将Mediator的注册放在GUI组件的createComplete后。以防Mediator访问出现空对象的情况。</p>
<p>再来看看主机组件MainMenuUI是怎么写的。</p>
<pre><code>export class MainMenuUI extends egret.gui.SkinnableComponent{
    <span class="keyword">public</span> addLabel:egret.gui.Label;
    <span class="keyword">public</span> scoreLabel:egret.gui.Label;
    <span class="keyword">public</span> highScoreLabel:egret.gui.Label;
    <span class="keyword">public</span> resetButton:egret.gui.Button;

    <span class="keyword">public</span> <span class="title">constructor</span>(){
        <span class="keyword">super</span>();
        <span class="keyword">this</span>.skinName = MainMenuUISkin;
        <span class="keyword">this</span>.addEventListener(egret.gui.UIEvent.CREATION_COMPLETE , <span class="keyword">this</span>.createCompleteEvent, <span class="keyword">this</span>);
    }

    <span class="keyword">public</span> <span class="title">createCompleteEvent</span>(event:egret.gui.UIEvent):<span class="keyword">void</span>{
        <span class="keyword">this</span>.removeEventListener(egret.gui.UIEvent.CREATION_COMPLETE , <span class="keyword">this</span>.createCompleteEvent, <span class="keyword">this</span>);
        ApplicationFacade.getInstance().registerMediator( <span class="keyword">new</span> MainMenuMediator(<span class="keyword">this</span>) );
    }

    <span class="keyword">public</span> <span class="title">partAdded</span>(partName:string, instance:any):<span class="keyword">void</span>{
        <span class="keyword">super</span>.partAdded(partName , instance);
        <span class="keyword">if</span>(<span class="keyword">this</span>.addLabel == instance){
            <span class="keyword">this</span>.addLabel.visible = <span class="keyword">false</span>;
        }
    }

    <span class="keyword">private</span> <span class="title">moveEffect_effectEndHandler</span>():<span class="keyword">void</span>
    {
        <span class="keyword">this</span>.addLabel.visible = <span class="keyword">false</span>;
    }

    <span class="javadoc">/**
    * 加分效果
    */</span>
    <span class="keyword">public</span> <span class="title">playScoreEffect</span>(addScore:number):<span class="keyword">void</span>{
        <span class="keyword">this</span>.addLabel.visible = <span class="keyword">true</span>;
        <span class="keyword">this</span>.addLabel.text = <span class="string">"+"</span>.concat(addScore.toString());
        egret.Tween.removeTweens(<span class="keyword">this</span>.addLabel);
        <span class="keyword">this</span>.addLabel.y = <span class="number">25</span>;
        egret.Tween.get(<span class="keyword">this</span>.addLabel).to({y:<span class="number">0</span>},<span class="number">300</span>).call(<span class="keyword">this</span>.moveEffect_effectEndHandler , <span class="keyword">this</span>);
    }
</code></pre><p>   }</p>
<p>在构造函数里面赋值skinName传入皮肤的类引用，这个解析过程就是SkinAdapter完成的。 可以看到主机组件有一个partAdded进行皮肤组件的配对。这个时候我们就可以获取到对应的皮肤组件，来进行操作了，</p>
<p><strong>②制作游戏区域————了解九宫格和容器布局</strong></p>
<p><img src="http://xzper.qiniudn.com/2014/06/游戏演示.png" alt=""></p>
<p>再次来观察这个游戏的主界面。有一张纯色的背景图，还有4x4个空白的格子，随着游戏的进行会多出带数字的格子，游戏结束了还会出现胜利的界面。</p>
<p>先来看看第一张图。也许你认为这个背景一张4x4的图片不就搞定了么。不过我们这个2048单元格的数量可是可以任意调整的，可以是5x5，或者6x6甚至更多，这样才具备灵活性。你只需要改变CommandData的size属性就可以了(PS:游戏胜利的条件默认是达成2048，也可以通过修改CommandData的winValue属性来修改条件比如8192时胜利或者像上面那样32的时候胜利，想不输都难)。</p>
<p>我们继承SkinnableContainer建立一个MainGameUI的类作为容器来显示上面的界面，当然同时还需要一个皮肤MainGameUISkin。先来确定skinParts，如下：</p>
<pre><code><span class="javadoc">/**
 * 和主机组件匹配的皮肤部件
 */</span>
<span class="keyword">private</span> <span class="keyword">static</span> _skinParts:Array&amp;lt;string&amp;gt; = [
    <span class="string">"tileGroup"</span>,<span class="string">"contentGroup"</span>
];

<span class="keyword">public</span> get <span class="title">skinParts</span>():Array&amp;lt;string&amp;gt;{
    <span class="keyword">return</span> MainGameUISkin._skinParts;
}

<span class="javadoc">/**
 * 游戏底背景
 */</span>
<span class="keyword">private</span> backUIAsset:egret.gui.UIAsset;

<span class="javadoc">/**
 * 背景格子容器
 */</span>
<span class="keyword">private</span> backGroundGroup:egret.gui.Group;

<span class="javadoc">/**
 * 格子容器
 */</span>
<span class="keyword">public</span> tileGroup:egret.gui.Group;

<span class="javadoc">/**
 * 内容
 */</span>
<span class="keyword">public</span> contentGroup:egret.gui.Group;
</code></pre><p>游戏游戏的底背景backUIAsset和背景格子容器backGroundGroup由于逻辑组件MainGameUI不需要关心所有这里不将其设置为skinParts。tileGroup是放置单元格的容器，contentGroup是SkinnableContainer的皮肤部件，SkinnableContainer的addElement方法实际上是添加到这个里面，换言之如果皮肤缺少这个contentGroup那么调用MainGameUI的addElement是看不到你要添加的子项的。 然后override这个createChildren方法将这些组件加入到显示列表。</p>
<pre><code><span class="keyword">public</span> createChildren():<span class="keyword">void</span>
{
    <span class="keyword">super</span>.createChildren;
    <span class="keyword">this</span>.backUIAsset = <span class="keyword">new</span> egret.gui.UIAsset();
    <span class="keyword">this</span>.backUIAsset.<span class="keyword">source</span> = <span class="string">"source.background"</span>;
    <span class="comment">//使用九宫格</span>
    <span class="keyword">this</span>.backUIAsset.scale9Grid = <span class="keyword">new</span> egret.gui.Rectangle(<span class="number">20</span>, <span class="number">20</span>, <span class="number">65</span>, <span class="number">65</span>);
    <span class="keyword">this</span>.backUIAsset.width = CommonData.<span class="keyword">size</span>*(TileUI.<span class="keyword">size</span> + <span class="keyword">this</span>.gap) + <span class="keyword">this</span>.gap;
    <span class="keyword">this</span>.backUIAsset.height = <span class="keyword">this</span>.backUIAsset.width;
    <span class="keyword">this</span>.addElement(<span class="keyword">this</span>.backUIAsset);

    <span class="comment">//使用格子布局</span>
    var layout:egret.gui.TileLayout = <span class="keyword">new</span> egret.gui.TileLayout();
    layout.columnCount = layout.rowCount = CommonData.<span class="keyword">size</span>;
    layout.horizontalGap = layout.verticalGap = <span class="keyword">this</span>.gap;
    <span class="keyword">this</span>.backGroundGroup = <span class="keyword">new</span> egret.gui.<span class="keyword">Group</span>();
    <span class="keyword">this</span>.backGroundGroup.x = <span class="keyword">this</span>.backGroundGroup.y = <span class="keyword">this</span>.gap;
    <span class="keyword">this</span>.backGroundGroup.layout = layout;
    <span class="keyword">this</span>.addElement(<span class="keyword">this</span>.backGroundGroup);
    <span class="keyword">this</span>.initBackGround(CommonData.<span class="keyword">size</span>);

    <span class="keyword">this</span>.tileGroup = <span class="keyword">new</span> egret.gui.<span class="keyword">Group</span>();
    <span class="keyword">this</span>.tileGroup.x = <span class="keyword">this</span>.tileGroup.y = <span class="keyword">this</span>.gap;
    <span class="keyword">this</span>.addElement(<span class="keyword">this</span>.tileGroup);

    <span class="keyword">this</span>.contentGroup = <span class="keyword">new</span> egret.gui.<span class="keyword">Group</span>();
    <span class="keyword">this</span>.contentGroup.percentHeight = <span class="keyword">this</span>.contentGroup.percentWidth = <span class="number">100</span>;
    <span class="keyword">this</span>.contentGroup.touchEnabled = <span class="keyword">false</span>;
    <span class="keyword">this</span>.addElement(<span class="keyword">this</span>.contentGroup);
}
</code></pre><p>先看backUIAsset，由于图片素材只是一个小的纯色圆角矩形，使用scale9Grid属性来设置九宫格缩放，这样设置了宽高就不会变形了。这里backGroundGroup设置了一个layout来确定布局。设置好间距以及行列数，向容器里面添加子项时就自动设置了位置了，不需要设置子项的x，y属性。TileLayout会自动布局。</p>
<pre><code><span class="keyword">private</span> initBackGround(size:<span class="built_in">number</span>):<span class="built_in">void</span>{
        <span class="comment">//背景格子</span>
        <span class="keyword">var</span> tile:egret.gui.UIAsset;
        <span class="keyword">var</span> totalNum:<span class="built_in">number</span> = size * size;
        <span class="keyword">for</span>(<span class="keyword">var</span> i:<span class="built_in">number</span> = <span class="number">0</span>;i &amp;lt; totalNum ; i++)
        {
            tile = <span class="keyword">new</span> egret.gui.UIAsset();
            tile.width = tile.height = TileUI.size;
            tile.source = <span class="string">"source.backtile"</span>;
            <span class="keyword">this</span>.backGroundGroup.addElement(tile);
        }
}
</code></pre><p><strong>③制作单元格————自定义属性</strong></p>
<p>单元格使用TileUI来定义。单元格有一个很重要的属性就是单元格的数据，这里使用value属性来表示。</p>
<pre><code><span class="keyword">private</span> valueChanged:<span class="keyword">boolean</span>;
<span class="keyword">private</span> _value:number;
<span class="javadoc">/**
 * 格子的数字
 */</span>
<span class="keyword">public</span> get <span class="title">value</span>():number{
    <span class="keyword">return</span> <span class="keyword">this</span>._value;
}

<span class="keyword">public</span> set <span class="title">value</span>(value:number){
    <span class="keyword">if</span>(value == <span class="keyword">this</span>._value){
        <span class="keyword">return</span>;
    }
    <span class="keyword">this</span>.valueChanged = <span class="keyword">true</span>;
    <span class="keyword">this</span>._value = value;
    <span class="keyword">this</span>.invalidateProperties();
}

<span class="keyword">public</span> <span class="title">commitProperties</span>():<span class="keyword">void</span>{
    <span class="keyword">if</span>(<span class="keyword">this</span>.valueChanged){
        <span class="keyword">this</span>.valueChanged = <span class="keyword">false</span>;
        <span class="keyword">this</span>.updateValue();
    }
}

<span class="keyword">private</span> <span class="title">updateValue</span>():<span class="keyword">void</span>{
    var mi:number = Math.log(<span class="keyword">this</span>._value)/Math.log(<span class="number">2</span>);
    <span class="keyword">this</span>.source = <span class="string">"number.number_"</span>+mi;
}
</code></pre><p>这里使用了invalidateProperties和commitProperties来完成属性的失效验证。当设置value的时候调用invalidateProperties，失效属性，GUI框架在下一次渲染的时候会调用commitProperties来完成属性的提交。失效验证简单说就是一种延迟应用改变的措施，这种失效验证在egret的GUI组件内部随处可见。这种自定义属性的例子只是其中之一，当组件的commitProperties方法被调用时组件已经准备完毕，所有的皮肤部件也匹配上了。这样也不用担心应用属性的时候报空的情况。这里通过设置TileUI的source属性来改变数字。还记得一开始的resource.json加载的number.json么。</p>
<pre><code>{
"<span class="attribute">frames</span>": <span class="value">{
    "<span class="attribute">number_1</span>": <span class="value">{"<span class="attribute">x</span>":<span class="value"><span class="number">106</span></span>, "<span class="attribute">y</span>":<span class="value"><span class="number">212</span></span>, "<span class="attribute">w</span>":<span class="value"><span class="number">105</span></span>, "<span class="attribute">h</span>":<span class="value"><span class="number">105</span></span>, "<span class="attribute">offX</span>":<span class="value"><span class="number">0</span></span>,"<span class="attribute">offY</span>":<span class="value"><span class="number">0</span></span>,"<span class="attribute">sourceW</span>":<span class="value"><span class="number">105</span></span>,"<span class="attribute">sourceH</span>":<span class="value"><span class="number">105</span></span>}</span>,
    "<span class="attribute">number_10</span>": <span class="value">{"<span class="attribute">x</span>":<span class="value"><span class="number">0</span></span>, "<span class="attribute">y</span>":<span class="value"><span class="number">318</span></span>, "<span class="attribute">w</span>":<span class="value"><span class="number">105</span></span>, "<span class="attribute">h</span>":<span class="value"><span class="number">105</span></span>, "<span class="attribute">offX</span>":<span class="value"><span class="number">0</span></span>,"<span class="attribute">offY</span>":<span class="value"><span class="number">0</span></span>,"<span class="attribute">sourceW</span>":<span class="value"><span class="number">105</span></span>,"<span class="attribute">sourceH</span>":<span class="value"><span class="number">105</span></span>}</span>,
    "<span class="attribute">number_11</span>": <span class="value">{"<span class="attribute">x</span>":<span class="value"><span class="number">0</span></span>, "<span class="attribute">y</span>":<span class="value"><span class="number">212</span></span>, "<span class="attribute">w</span>":<span class="value"><span class="number">105</span></span>, "<span class="attribute">h</span>":<span class="value"><span class="number">105</span></span>, "<span class="attribute">offX</span>":<span class="value"><span class="number">0</span></span>,"<span class="attribute">offY</span>":<span class="value"><span class="number">0</span></span>,"<span class="attribute">sourceW</span>":<span class="value"><span class="number">105</span></span>,"<span class="attribute">sourceH</span>":<span class="value"><span class="number">105</span></span>}</span>,
    "<span class="attribute">number_12</span>": <span class="value">{"<span class="attribute">x</span>":<span class="value"><span class="number">0</span></span>, "<span class="attribute">y</span>":<span class="value"><span class="number">106</span></span>, "<span class="attribute">w</span>":<span class="value"><span class="number">105</span></span>, "<span class="attribute">h</span>":<span class="value"><span class="number">105</span></span>, "<span class="attribute">offX</span>":<span class="value"><span class="number">0</span></span>,"<span class="attribute">offY</span>":<span class="value"><span class="number">0</span></span>,"<span class="attribute">sourceW</span>":<span class="value"><span class="number">105</span></span>,"<span class="attribute">sourceH</span>":<span class="value"><span class="number">105</span></span>}</span>,
    "<span class="attribute">number_13</span>": <span class="value">{"<span class="attribute">x</span>":<span class="value"><span class="number">0</span></span>, "<span class="attribute">y</span>":<span class="value"><span class="number">0</span></span>, "<span class="attribute">w</span>":<span class="value"><span class="number">105</span></span>, "<span class="attribute">h</span>":<span class="value"><span class="number">105</span></span>, "<span class="attribute">offX</span>":<span class="value"><span class="number">0</span></span>,"<span class="attribute">offY</span>":<span class="value"><span class="number">0</span></span>,"<span class="attribute">sourceW</span>":<span class="value"><span class="number">105</span></span>,"<span class="attribute">sourceH</span>":<span class="value"><span class="number">105</span></span>}</span>,
    "<span class="attribute">number_2</span>": <span class="value">{"<span class="attribute">x</span>":<span class="value"><span class="number">212</span></span>, "<span class="attribute">y</span>":<span class="value"><span class="number">318</span></span>, "<span class="attribute">w</span>":<span class="value"><span class="number">105</span></span>, "<span class="attribute">h</span>":<span class="value"><span class="number">105</span></span>, "<span class="attribute">offX</span>":<span class="value"><span class="number">0</span></span>,"<span class="attribute">offY</span>":<span class="value"><span class="number">0</span></span>,"<span class="attribute">sourceW</span>":<span class="value"><span class="number">105</span></span>,"<span class="attribute">sourceH</span>":<span class="value"><span class="number">105</span></span>}</span>,
    "<span class="attribute">number_3</span>": <span class="value">{"<span class="attribute">x</span>":<span class="value"><span class="number">212</span></span>, "<span class="attribute">y</span>":<span class="value"><span class="number">212</span></span>, "<span class="attribute">w</span>":<span class="value"><span class="number">105</span></span>, "<span class="attribute">h</span>":<span class="value"><span class="number">105</span></span>, "<span class="attribute">offX</span>":<span class="value"><span class="number">0</span></span>,"<span class="attribute">offY</span>":<span class="value"><span class="number">0</span></span>,"<span class="attribute">sourceW</span>":<span class="value"><span class="number">105</span></span>,"<span class="attribute">sourceH</span>":<span class="value"><span class="number">105</span></span>}</span>,
    "<span class="attribute">number_4</span>": <span class="value">{"<span class="attribute">x</span>":<span class="value"><span class="number">212</span></span>, "<span class="attribute">y</span>":<span class="value"><span class="number">106</span></span>, "<span class="attribute">w</span>":<span class="value"><span class="number">105</span></span>, "<span class="attribute">h</span>":<span class="value"><span class="number">105</span></span>, "<span class="attribute">offX</span>":<span class="value"><span class="number">0</span></span>,"<span class="attribute">offY</span>":<span class="value"><span class="number">0</span></span>,"<span class="attribute">sourceW</span>":<span class="value"><span class="number">105</span></span>,"<span class="attribute">sourceH</span>":<span class="value"><span class="number">105</span></span>}</span>,
    "<span class="attribute">number_5</span>": <span class="value">{"<span class="attribute">x</span>":<span class="value"><span class="number">212</span></span>, "<span class="attribute">y</span>":<span class="value"><span class="number">0</span></span>, "<span class="attribute">w</span>":<span class="value"><span class="number">105</span></span>, "<span class="attribute">h</span>":<span class="value"><span class="number">105</span></span>, "<span class="attribute">offX</span>":<span class="value"><span class="number">0</span></span>,"<span class="attribute">offY</span>":<span class="value"><span class="number">0</span></span>,"<span class="attribute">sourceW</span>":<span class="value"><span class="number">105</span></span>,"<span class="attribute">sourceH</span>":<span class="value"><span class="number">105</span></span>}</span>,
    "<span class="attribute">number_6</span>": <span class="value">{"<span class="attribute">x</span>":<span class="value"><span class="number">106</span></span>, "<span class="attribute">y</span>":<span class="value"><span class="number">318</span></span>, "<span class="attribute">w</span>":<span class="value"><span class="number">105</span></span>, "<span class="attribute">h</span>":<span class="value"><span class="number">105</span></span>, "<span class="attribute">offX</span>":<span class="value"><span class="number">0</span></span>,"<span class="attribute">offY</span>":<span class="value"><span class="number">0</span></span>,"<span class="attribute">sourceW</span>":<span class="value"><span class="number">105</span></span>,"<span class="attribute">sourceH</span>":<span class="value"><span class="number">105</span></span>}</span>,
    "<span class="attribute">number_7</span>": <span class="value">{"<span class="attribute">x</span>":<span class="value"><span class="number">318</span></span>, "<span class="attribute">y</span>":<span class="value"><span class="number">0</span></span>, "<span class="attribute">w</span>":<span class="value"><span class="number">105</span></span>, "<span class="attribute">h</span>":<span class="value"><span class="number">105</span></span>, "<span class="attribute">offX</span>":<span class="value"><span class="number">0</span></span>,"<span class="attribute">offY</span>":<span class="value"><span class="number">0</span></span>,"<span class="attribute">sourceW</span>":<span class="value"><span class="number">105</span></span>,"<span class="attribute">sourceH</span>":<span class="value"><span class="number">105</span></span>}</span>,
    "<span class="attribute">number_8</span>": <span class="value">{"<span class="attribute">x</span>":<span class="value"><span class="number">106</span></span>, "<span class="attribute">y</span>":<span class="value"><span class="number">106</span></span>, "<span class="attribute">w</span>":<span class="value"><span class="number">105</span></span>, "<span class="attribute">h</span>":<span class="value"><span class="number">105</span></span>, "<span class="attribute">offX</span>":<span class="value"><span class="number">0</span></span>,"<span class="attribute">offY</span>":<span class="value"><span class="number">0</span></span>,"<span class="attribute">sourceW</span>":<span class="value"><span class="number">105</span></span>,"<span class="attribute">sourceH</span>":<span class="value"><span class="number">105</span></span>}</span>,
    "<span class="attribute">number_9</span>": <span class="value">{"<span class="attribute">x</span>":<span class="value"><span class="number">106</span></span>, "<span class="attribute">y</span>":<span class="value"><span class="number">0</span></span>, "<span class="attribute">w</span>":<span class="value"><span class="number">105</span></span>, "<span class="attribute">h</span>":<span class="value"><span class="number">105</span></span>, "<span class="attribute">offX</span>":<span class="value"><span class="number">0</span></span>,"<span class="attribute">offY</span>":<span class="value"><span class="number">0</span></span>,"<span class="attribute">sourceW</span>":<span class="value"><span class="number">105</span></span>,"<span class="attribute">sourceH</span>":<span class="value"><span class="number">105</span></span>}

</span>}</span>,
"<span class="attribute">file</span>": <span class="value"><span class="string">"number.png"</span>
</span>}
</code></pre><p>这个sheet记录的每一张图也有一个名称比如2这个数字就是number_1加上number这个sheet名称使用”.”符号连接，所以获取”2”这个数字的图片就可以这样写this.source = “number.number_1”。根据值的不同取2的对数得到相应的下标数字。</p>
<p><strong>④制作胜负界面————自定义组件状态</strong></p>
<p>游戏结束之后会出现胜负的界面。但是胜负界面应该是两套不同的素材，那么我们是不是可以制作两个皮肤来根据胜负来切换？这样当然可以。但是，还有一种更简单的办法就是使用自定义状态，只需要一个皮肤类就可以完成两种视图的切换。</p>
<p>新建一个ResultWindow类继承自SkinnableComponent，然后新建ResultWindowSkin。在ResultWindowSkin的构造函数中定义两个状态win和failed。</p>
<pre><code><span class="keyword">public</span> <span class="constructor"><span class="keyword">constructor</span>()</span>{
    <span class="keyword">super</span>();
    <span class="keyword">this</span>.states = [<span class="string">"win"</span>,<span class="string">"failed"</span>];
}
</code></pre><p>然后加入两个皮肤部件button和resultUI</p>
<pre><code><span class="keyword">private</span> <span class="keyword">static</span> _skinParts:Array&lt;string&gt; = [<span class="string">"button"</span>,<span class="string">"resultUI"</span>];

<span class="keyword">public</span> get <span class="title">skinParts</span>():Array&lt;string&gt;{
    <span class="keyword">return</span> ResultWindowSkin._skinParts;
}

<span class="javadoc">/**
 * 按钮
 */</span>
<span class="keyword">public</span> button:egret.gui.Button;

<span class="javadoc">/**
 * 结果文本
 */</span>
<span class="keyword">public</span> resultUI:egret.gui.UIAsset;
</code></pre><p>在createChildren里面将皮肤部件布局好位置。最后重写commitCurrentState方法来根据对应的状态来改变部件的skin。</p>
<pre><code><span class="keyword">public</span> <span class="title">commitCurrentState</span>():<span class="keyword">void</span> {
    <span class="keyword">super</span>.commitCurrentState();
    <span class="keyword">if</span>(<span class="keyword">this</span>.currentState == <span class="string">"win"</span>)
    {
        <span class="keyword">this</span>.resultUI.source = <span class="string">"source.result_sucess"</span>;
        <span class="keyword">this</span>.button.skinName = ContinueButtonSkin;
    }
    <span class="keyword">else</span>
    {
        <span class="keyword">this</span>.resultUI.source = <span class="string">"source.result_failed"</span>;
        <span class="keyword">this</span>.button.skinName = ResetButtonSkin;
    }
}
</code></pre><p>这样还没有完，我们需要在主机组件里面定义何时是何种状态，在ResultWindow中重写getCurrentSkinState来定义皮肤状态。</p>
<pre><code><span class="keyword">private</span> _win:boolean = <span class="keyword">false</span>;
<span class="keyword">public</span> <span class="keyword">get</span> <span class="title">win</span>():boolean{
    <span class="keyword">return</span> <span class="keyword">this</span>._win;
}

<span class="keyword">public</span> <span class="keyword">set</span> <span class="title">win</span>(<span class="keyword">value</span>:boolean){
    <span class="keyword">if</span>(<span class="keyword">value</span> == <span class="keyword">this</span>._win)
        <span class="keyword">return</span>;
    <span class="keyword">this</span>._win = <span class="keyword">value</span>;
    <span class="keyword">this</span>.invalidateSkinState();
}

<span class="keyword">public</span> <span class="title">getCurrentSkinState</span>():<span class="keyword">string</span> {
    <span class="keyword">return</span> <span class="keyword">this</span>.win?<span class="string">"win"</span>:<span class="string">"failed"</span>;
}
</code></pre><p>当外界设置win的值时调用invalidateSkinState来失效皮肤状态，在框架下次渲染的时候，调用SkinnableComponent的validateSkinState方法同时通过getCurrentSkinState来获取皮肤状态，通知皮肤去改变视图。这又是失效验证机制的一次完美使用。我们只需要调用失效，然后重写对应的验证方法就行了。事实上，按钮的up，down，disable之类的状态也是这样实现的。</p>
<p>egret的GUI库，集合了Flex和<a href="http://flexlite.org" target="_blank" rel="external">FlexLite</a>的核心思想。实现了自动布局，皮肤分离，组件的三层失效验证机制。快来膜拜作者<a href="http://blog.domlib.com/" target="_blank" rel="external">DOM</a>大神吧。</p>
<p><strong>6.优化游戏</strong></p>
<p><strong>①使用对象池</strong></p>
<p>在游戏里面随着游戏的进行，每一次移动都有一个格子组件TileUI的创建，当游戏久了会造成巨大的内存开销。这里使用对象池技术。当一个对象使用完毕时，放入对象池，下次需要使用时取出来，这样避免了对象的重复创建，节约了内存。具体的实现参考ObjectPool这个类。具体使用在MainGameUI里面，如下：</p>
<pre><code><span class="javadoc">/**
 * 创建一个格子
 */</span>
<span class="keyword">public</span> <span class="title">createTile</span>(tileVO:TileVO):<span class="keyword">void</span>{
    var tile:TileUI = &amp;lt;TileUI&amp;gt;(ObjectPool.getPool(<span class="string">"game.TileUI"</span>).borrowObject());  <span class="comment">//从对象池创建</span>
   ......
   ......
}
</code></pre><p>当对象池里面没有TileUI时使用会new一个出来，否则直接从对象池获取。</p>
<pre><code><span class="javadoc">/**
 * 清除一个格子
 */</span>
<span class="keyword">public</span> <span class="title">removeTile</span>(tileVO:TileVO):<span class="keyword">void</span>{
    var tileUI:TileUI = <span class="keyword">this</span>.getTileUI(tileVO.x , tileVO.y);
    <span class="keyword">if</span>(tileUI){
        <span class="keyword">this</span>.tileGroup.removeElement(tileUI);
        ObjectPool.getPool(<span class="string">"game.TileUI"</span>).returnObject(tileUI);
    }
}
</code></pre><p>当格子销毁时，回收到对象池，以备下次使用。</p>
<p>另外由于js没有提供弱引用特性，在对象池里面的对象要彻底销毁就需要手动了。</p>
<p><strong>②针对不同设备</strong></p>
<p>游戏在PC我们使用键盘上的方向键操控游戏，但是在移动设备上就需要使用手势来操控了，通过egret.MainContext.deviceType这个值来获取平台 。具体实现在ApplicationMediator中：</p>
<pre><code><span class="comment">//为PC和移动端设置不同的移动策略</span>
<span class="keyword">if</span>(egret.MainContext.deviceType != egret.MainContext.DEVICE_MOBILE)
{
    <span class="keyword">var</span> self = <span class="keyword">this</span>;
    <span class="built_in">document</span>.addEventListener(<span class="string">"keydown"</span>,<span class="function"><span class="keyword">function</span><span class="params">(event:KeyboardEvent)</span></span>{
        <span class="keyword">switch</span> (event.keyCode) {
            ....省略键盘事件......
        }
    });
}
<span class="keyword">else</span>
{
    <span class="keyword">this</span>.main.addEventListener(egret.TouchEvent.TOUCH_BEGIN , <span class="keyword">this</span>.mouseDownHandle , <span class="keyword">this</span>)
}
</code></pre><p>由于egret目前没有提供手势的API，这里我们自己实现手势。监听TOUCH_BEGIN，TOUCH_MOVE，TOUCH_END和LEAVE_STAGE这四个事件。具体实现如下：</p>
<pre><code><span class="keyword">private</span> downPoint:egret.Point;
<span class="keyword">private</span> movePoint:egret.Point;
<span class="keyword">private</span> <span class="title">mouseDownHandle</span>(<span class="keyword">event</span>:egret.TouchEvent):<span class="keyword">void</span>
{
    egret.UIGlobals.stage.addEventListener(egret.TouchEvent.TOUCH_MOVE,<span class="keyword">this</span>.stage_mouseMoveHandler,<span class="keyword">this</span>);
    egret.UIGlobals.stage.addEventListener(egret.TouchEvent.TOUCH_END,<span class="keyword">this</span>.stage_mouseUpHandler,<span class="keyword">this</span>);
    egret.UIGlobals.stage.addEventListener(egret.Event.LEAVE_STAGE,<span class="keyword">this</span>.stage_mouseUpHandler,<span class="keyword">this</span>);

    <span class="keyword">this</span>.downPoint = <span class="keyword">this</span>.main.globalToLocal(<span class="keyword">event</span>.stageX, <span class="keyword">event</span>.stageY);
}

<span class="keyword">private</span> needMove:boolean;
<span class="keyword">private</span> <span class="title">stage_mouseMoveHandler</span>(<span class="keyword">event</span>:egret.TouchEvent):<span class="keyword">void</span>{
    <span class="keyword">if</span>(!<span class="keyword">this</span>.movePoint)
        <span class="keyword">this</span>.movePoint = <span class="keyword">new</span> egret.Point();
    <span class="keyword">this</span>.movePoint.x = <span class="keyword">event</span>.stageX;
    <span class="keyword">this</span>.movePoint.y = <span class="keyword">event</span>.stageY;
    <span class="keyword">if</span> (<span class="keyword">this</span>.needMove)
        <span class="keyword">return</span>;
    <span class="keyword">this</span>.needMove = <span class="keyword">true</span>;
}

<span class="keyword">public</span> <span class="title">stage_mouseUpHandler</span>(<span class="keyword">event</span>:egret.Event):<span class="keyword">void</span>{
    egret.UIGlobals.stage.removeEventListener(egret.TouchEvent.TOUCH_MOVE,
        <span class="keyword">this</span>.stage_mouseMoveHandler,
        <span class="keyword">this</span>);
    egret.UIGlobals.stage.removeEventListener(egret.TouchEvent.TOUCH_END,
        <span class="keyword">this</span>.stage_mouseUpHandler,
        <span class="keyword">this</span>);
    egret.UIGlobals.stage.addEventListener(egret.Event.LEAVE_STAGE,
        <span class="keyword">this</span>.stage_mouseUpHandler,
        <span class="keyword">this</span>);
    <span class="keyword">if</span>(<span class="keyword">this</span>.needMove){
        <span class="keyword">this</span>.updateWhenMouseUp();
        <span class="keyword">this</span>.needMove = <span class="keyword">false</span>;
    }
}

<span class="comment">/**
 * 移动设备上，判断移动方向
 */</span>
<span class="keyword">private</span> <span class="title">updateWhenMouseUp</span>():<span class="keyword">void</span>
{
    <span class="keyword">var</span> p:egret.Point = <span class="keyword">this</span>.main.globalToLocal(<span class="keyword">this</span>.movePoint.x, <span class="keyword">this</span>.movePoint.y ,egret.Point.identity);
    <span class="keyword">var</span> offSetX:number = p.x - <span class="keyword">this</span>.downPoint.x;
    <span class="keyword">var</span> offSetY:number = p.y - <span class="keyword">this</span>.downPoint.y;

    <span class="keyword">if</span>(offSetY&amp;lt;<span class="number">0</span> &amp;amp;&amp;amp; Math.abs(offSetY)&amp;gt;Math.abs(offSetX))  <span class="comment">//上</span>
    {
        <span class="keyword">this</span>.doMove(<span class="number">0</span>);
    }
    <span class="keyword">else</span> <span class="keyword">if</span>(offSetX&amp;gt;<span class="number">0</span> &amp;amp;&amp;amp; offSetX&amp;gt;Math.abs(offSetY))  <span class="comment">//右</span>
    {
        <span class="keyword">this</span>.doMove(<span class="number">1</span>);
    }
    <span class="keyword">else</span> <span class="keyword">if</span>(offSetY&amp;gt;<span class="number">0</span> &amp;amp;&amp;amp; offSetY&amp;gt;Math.abs(offSetX))  <span class="comment">//下</span>
    {
        <span class="keyword">this</span>.doMove(<span class="number">2</span>);
    }
    <span class="keyword">else</span> <span class="keyword">if</span>(offSetX&amp;lt;<span class="number">0</span> &amp;amp;&amp;amp; Math.abs(offSetX)&amp;gt;Math.abs(offSetY))  <span class="comment">//左</span>
    {
        <span class="keyword">this</span>.doMove(<span class="number">3</span>);
    }
}
</code></pre><p><strong>③动画效果</strong></p>
<p>游戏里面格子的创建，移动，合并，都需要一个缓动效果来支持。这里面最大的问题就是，缓动效果是持续时间的，而往往数据的改变是一瞬间。比如：一个操作合并了两个格子，其中一个需要移动，并且移动完成后要移除掉，此时新的格子也要出现。但是往往数据层把这些数据是同时发过来的，所以我们需要调节时机来让效果更好。比如格子的创建，我们延迟100毫秒显示在舞台上，因为在创建的同时其他格子会移动，所以等其他格子移动完成了后显示出来比较好。再比如格子的合并，实际上就是一个格子移动，移动完成后消失，目标位置格子改变数字并且出现缩放效果。这样要注意的就是移动之前调整将移动的格子的层级显示在最下面，避免移动的时候挡在目标位置格子的上面。</p>
<p><strong>7.性能</strong></p>
<p>egret的工作流还是很高效的，工具也不少，架构设计集各家所长。最后发布游戏在PC上运行是满帧运行，比原版甚至更快。在手机上运行也不错，体验超过了某些原生语言开发的2048。</p>
<p>最后交出源代码：<a href="https://github.com/f111fei/2048egret" target="_blank" rel="external">点我传送</a></p>

    
  </div>
  <footer>
    
      
  
  <div class="categories">
    <a href="/categories/Egret/">Egret</a>
  </div>

      
  
  <div class="tags">
    <a href="/tags/Egret/">Egret</a>
  </div>

    
    <div class="clearfix"></div>
  </footer>
</article>


<div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div>
<script src="https://img1.cache.netease.com/f2e/tie/yun/sdk/loader.js"></script>
<script>
var cloudTieConfig = {
  url: document.location.href, 
  sourceId: "",
  productKey: "e80374eada25435a87d61c80f74ac702",
  target: "cloud-tie-wrapper"
};
var yunManualLoad = true;
Tie.loader("aHR0cHM6Ly9hcGkuZ2VudGllLjE2My5jb20vcGMvbGl2ZXNjcmlwdC5odG1s", true);
</script>
</div>
  </div>
  <div class="widget-wrapper">
    <aside id="sidebar">
  
  
    
      
      

<div class="widget tag first">
  <h3 class="title">分类</h3>
  <ul class="entry">
  
    <li><a href="/categories/ActionScript3/">ActionScript3</a><small>4</small></li>
  
    <li><a href="/categories/Egret/">Egret</a><small>1</small></li>
  
    <li><a href="/categories/nodejs/">nodejs</a><small>6</small></li>
  
    <li><a href="/categories/感悟/">感悟</a><small>1</small></li>
  
    <li><a href="/categories/未分类/">未分类</a><small>3</small></li>
  
    <li><a href="/categories/框架/">框架</a><small>2</small></li>
  
    <li><a href="/categories/解读/">解读</a><small>2</small></li>
  
  </ul>
</div>

    
      
      

<div class="widget tag">
  <h3 class="title">标签</h3>
  <ul class="entry">
  
    <li><a href="/tags/ActionScript3/">ActionScript3</a><small>2</small></li>
  
    <li><a href="/tags/Egret/">Egret</a><small>1</small></li>
  
    <li><a href="/tags/FlexLite/">FlexLite</a><small>2</small></li>
  
    <li><a href="/tags/Hexo/">Hexo</a><small>1</small></li>
  
    <li><a href="/tags/gulp/">gulp</a><small>1</small></li>
  
    <li><a href="/tags/nodejs/">nodejs</a><small>6</small></li>
  
    <li><a href="/tags/puremvc/">puremvc</a><small>1</small></li>
  
    <li><a href="/tags/vscode/">vscode</a><small>5</small></li>
  
    <li><a href="/tags/架构/">架构</a><small>1</small></li>
  
  </ul>
</div>

    
      
      

<div class="widget tagcloud">
  <h3 class="title">标签云</h3>
  <div class="entry">
    <a href="/tags/ActionScript3/" style="font-size: 13.33px;">ActionScript3</a><a href="/tags/Egret/" style="font-size: 10.00px;">Egret</a><a href="/tags/FlexLite/" style="font-size: 13.33px;">FlexLite</a><a href="/tags/Hexo/" style="font-size: 10.00px;">Hexo</a><a href="/tags/gulp/" style="font-size: 10.00px;">gulp</a><a href="/tags/nodejs/" style="font-size: 20.00px;">nodejs</a><a href="/tags/puremvc/" style="font-size: 10.00px;">puremvc</a><a href="/tags/vscode/" style="font-size: 16.67px;">vscode</a><a href="/tags/架构/" style="font-size: 10.00px;">架构</a>
  </div>
</div>

    
      
      

<div class="widget recent-posts first newline">
  <h3 class="title">最近的文章</h3>
  <ul class="entry">
    
      <li>
        <a href="/2016/06/14/wing3/">EgretWing3入门指南</a>
      </li>
    
      <li>
        <a href="/2016/04/17/vscode源码剖析/">vscode源码剖析</a>
      </li>
    
      <li>
        <a href="/2016/04/09/gulp流式操作/">gulp流式操作</a>
      </li>
    
      <li>
        <a href="/2015/11/29/调试vscode/">调试vscode</a>
      </li>
    
      <li>
        <a href="/2015/11/29/编译vscode/">编译vscode</a>
      </li>
    
  </ul>
</div>

    
      
      

<div class="widget blogroll">
  <h3 class="title">友情链接</h3>
  <ul class="entry">
  
    
    <li><a href="http://www.idom.me" target="_blank">iDom</a></li>
  
    
    <li><a href="http://featherj.org" target="_blank">featherj</a></li>
  
    
    <li><a href="http://ashan.org" target="_blank">A闪</a></li>
  
    
    <li><a href="http://xsstomy.com" target="_blank">xsstomy</a></li>
  
  </ul>
</div>

    
  
</aside>
<div class="clearfix"></div>
  </div>
  <footer id="footer"><div class="copyright">
  
  &copy; 2017 <a href="/">xzper</a>
  
</div>
<div class="theme-copyright">
  Theme by <a href="https://github.com/orderedlist" target="_blank">orderedlist</a>
   | 
  Redesign by <a href="http://heroicyang.com/" target="_blank">Heroic Yang</a>
</div>
<div class="clearfix"></div></footer>
  <script src="/js/scale.fix.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


<script type="text/javascript">
  var duoshuoQuery = { short_name: 'xzper' };
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';
    ds.async = true;
    ds.src = 'http://static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
  (function($){
    $('.fancybox').fancybox();
  })(jQuery);
</script>

</body>
</html>